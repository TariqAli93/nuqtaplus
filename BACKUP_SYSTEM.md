# نظام النسخ الاحتياطي - Database Backup System

## نظرة عامة

نظام النسخ الاحتياطي في CodeLIMS يدعم النسخ الاحتياطي التلقائي واليدوي **لقاعدة البيانات فقط**.

## المميزات

### 1. النسخ الاحتياطي اليدوي

- إنشاء نسخة احتياطية من قاعدة البيانات في أي وقت
- **اختيار مكان حفظ النسخة الاحتياطية** (ميزة جديدة)
- تحميل النسخ الاحتياطية السابقة
- حذف النسخ الاحتياطية القديمة

### 2. النسخ الاحتياطي التلقائي

- جدولة النسخ الاحتياطية التلقائية (يومي، أسبوعي، شهري)
- تنظيف النسخ القديمة تلقائياً حسب الحد الأقصى المحدد
- إمكانية تفعيل/تعطيل النسخ التلقائي

### 3. الاستعادة

- استعادة قاعدة البيانات من نسخة احتياطية سابقة
- إنشاء نسخة احتياطية طارئة قبل الاستعادة تلقائياً

## الإعدادات

### إعدادات النسخ الاحتياطي التلقائي

في جدول `settings`:

```javascript
{
  'backup.autoEnabled': 'true',      // تفعيل/تعطيل النسخ التلقائي
  'backup.frequency': 'daily',        // التكرار: daily, weekly, monthly
  'backup.maxFiles': '10'            // الحد الأقصى للنسخ المحفوظة
}
```

## البنية

### Backend Files

- **Controller**: `packages/backend/src/controllers/backupController.js`
  - إنشاء النسخ الاحتياطية
  - استعادة قاعدة البيانات
  - إدارة النسخ الاحتياطية (قائمة، تحميل، حذف)

- **Service**: `packages/backend/src/services/backupService.js`
  - جدولة النسخ التلقائي
  - تنظيف النسخ القديمة
  - إحصائيات النسخ الاحتياطي

- **Routes**: `packages/backend/src/routes/backupRoutes.js`
  - `POST /api/backup/create` - إنشاء نسخة احتياطية
  - `POST /api/backup/restore` - استعادة من نسخة احتياطية
  - `GET /api/backup/list` - قائمة النسخ الاحتياطية
  - `GET /api/backup/download/:id` - تحميل نسخة احتياطية
  - `DELETE /api/backup/:id` - حذف نسخة احتياطية

### Frontend Files

- **Component**: `packages/frontend/src/components/settings/BackupSettings.vue`
  - واجهة إدارة النسخ الاحتياطي
  - إعدادات النسخ التلقائي

## مسار الملفات

النسخ الاحتياطية تُحفظ في:

```
packages/backend/data/backups/
```

قاعدة البيانات الرئيسية:

```
packages/backend/data/codelims.db
```

## أمثلة الاستخدام

### إنشاء نسخة احتياطية يدوية

#### حفظ داخل مجلد النسخ الاحتياطي

```javascript
POST /api/backup/create
Authorization: Bearer <token>

Body:
{
  "name": "نسخة احتياطية يدوية"
}
```

#### حفظ في مكان محدد (عبر واجهة المستخدم)

في واجهة المستخدم، استخدم زر "إنشاء وحفظ في مكان محدد" لفتح نافذة حوار تسمح لك باختيار مكان حفظ النسخة الاحتياطية على جهازك.

### استعادة قاعدة البيانات

```javascript
POST /api/backup/restore
Authorization: Bearer <token>
Content-Type: multipart/form-data

Body:
- backup: <database-file.db>
```

### تحديث إعدادات النسخ التلقائي

```javascript
PUT /api/settings/bulk
Authorization: Bearer <token>

Body:
{
  "backup.autoEnabled": "true",
  "backup.frequency": "daily",
  "backup.maxFiles": "15"
}
```

## ملاحظات مهمة

1. **النسخ الاحتياطي لقاعدة البيانات فقط**: النظام لا يشمل الملفات المرفقة (مثل الشعارات)
2. **نسخة احتياطية طارئة**: عند استعادة قاعدة بيانات، يتم إنشاء نسخة احتياطية طارئة تلقائياً
3. **التنظيف التلقائي**: عند تجاوز العدد المحدد، يتم حذف النسخ الأقدم تلقائياً
4. **تحديث التكرار**: عند تغيير إعدادات النسخ التلقائي، يتم إعادة تشغيل الخدمة تلقائياً
5. **اختيار مكان الحفظ**: يمكنك اختيار أي مكان على جهازك لحفظ النسخة الاحتياطية

## الأمان

- جميع endpoints محمية بـ JWT authentication
- التحقق من صلاحية ملفات قاعدة البيانات المرفوعة
- إنشاء نسخة احتياطية طارئة قبل أي عملية استعادة

## التطوير المستقبلي

محتملات التحسين:

- ضغط النسخ الاحتياطية (ZIP)
- تشفير النسخ الاحتياطية
- رفع النسخ لخدمات التخزين السحابي
- إشعارات عند فشل النسخ التلقائي

## التحديثات الأخيرة

### النسخة الحالية

- ✅ **اختيار مكان الحفظ**: تم إضافة ميزة اختيار مكان حفظ النسخة الاحتياطية عبر نافذة حوار نظام التشغيل
- ✅ زر جديد "إنشاء وحفظ في مكان محدد" في واجهة المستخدم
- ✅ دعم Electron IPC لفتح حوار الحفظ وكتابة الملفات
- ✅ حفظ النسخة الاحتياطية في أي مكان على القرص
